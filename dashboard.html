<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP · Dashboard de Chamados</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<style>
  :root {
    --g1: #0D3D2A; --g2: #1E6B52; --g3: #3AAB85; --g4: #5DC9A5; --g5: #C8EFE2; --g6: #EBF9F4;
    --red: #E05C5C; --yellow: #F4A261; --bg: #F2FAF6; --card: #FFFFFF; --text: #0D1F17;
    --sub: #5A7A6A; --border: #D4EDE2;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  header { background: var(--g1); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 64px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 20px rgba(0,0,0,0.25); }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo-badge { width: 38px; height: 38px; background: var(--g3); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: white; letter-spacing: 0.5px; }
  .header-title { font-size: 16px; font-weight: 600; color: white; }
  .header-sub { font-size: 12px; color: var(--g4); margin-top: 1px; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .pulse-dot { width: 8px; height: 8px; background: var(--g4); border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.3); } }
  .live-label { font-size: 12px; color: var(--g4); font-family: 'DM Mono', monospace; }
  #last-update { font-size: 11px; color: #5a8570; font-family: 'DM Mono', monospace; }
  main { max-width: 1300px; margin: 0 auto; padding: 28px 24px 48px; }
  .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px 22px; position: relative; overflow: hidden; transition: transform 0.2s; }
  .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--accent, var(--g3)); }
  .kpi-label { font-size: 11px; font-weight: 600; color: var(--sub); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .kpi-value { font-size: 36px; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .kpi-note { font-size: 12px; color: var(--sub); }
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 22px 24px 18px; }
  .chart-card.wide { grid-column: 1 / -1; }
  .chart-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
  .chart-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .chart-tag { font-size: 10px; font-weight: 600; background: var(--g6); color: var(--g2); border: 1px solid var(--g5); border-radius: 20px; padding: 3px 10px; }
  .loading-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 220px; gap: 14px; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--g5); border-top-color: var(--g3); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead tr { background: var(--g1); color: white; }
  thead th { padding: 11px 14px; text-align: left; font-size: 11px; text-transform: uppercase; }
  tbody tr { border-bottom: 1px solid var(--border); }
  tbody td { padding: 10px 14px; color: var(--text); }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .badge-alta { background: #FFE5E5; color: #C43E3E; }
  .badge-media { background: #FFF4E5; color: #C47A1A; }
  .badge-baixa { background: #E8F7F1; color: #1A7A52; }
  footer { text-align: center; padding: 24px; font-size: 12px; color: var(--sub); }
  @media (max-width: 768px) { .kpi-row { grid-template-columns: 1fr 1fr; } .charts-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo-badge">CAP</div>
    <div>
      <div class="header-title">Dashboard de Chamados</div>
      <div class="header-sub">Central de Apoio Pedagógico · FMC</div>
    </div>
  </div>
  <div class="header-right">
    <div class="pulse-dot"></div>
    <span class="live-label">AO VIVO</span>
    <span id="last-update">—</span>
  </div>
</header>

<main>
  <div class="kpi-row">
    <div class="kpi-card" style="--accent:#3AAB85">
      <div class="kpi-label">Total de Chamados</div>
      <div class="kpi-value" id="kpi-total">—</div>
      <div class="kpi-note">desde o início</div>
    </div>
    <div class="kpi-card" style="--accent:#E05C5C">
      <div class="kpi-label">Alta Urgência</div>
      <div class="kpi-value" id="kpi-alta">—</div>
      <div class="kpi-note" id="kpi-alta-pct">—</div>
    </div>
    <div class="kpi-card" style="--accent:#F4A261">
      <div class="kpi-label">Média Urgência</div>
      <div class="kpi-value" id="kpi-media">—</div>
      <div class="kpi-note" id="kpi-media-pct">—</div>
    </div>
    <div class="kpi-card" style="--accent:#5DC9A5">
      <div class="kpi-label">Mais Frequente</div>
      <div class="kpi-value" style="font-size:18px" id="kpi-top-cat">—</div>
      <div class="kpi-note" id="kpi-top-cat-n">—</div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Chamados por Categoria</div>
        <span class="chart-tag">BARRAS</span>
      </div>
      <div class="chart-area" id="chart-categorias">
        <div class="loading-wrap"><div class="spinner"></div></div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Nível de Urgência</div>
        <span class="chart-tag">PIZZA</span>
      </div>
      <div class="chart-area" id="chart-urgencia">
        <div class="loading-wrap"><div class="spinner"></div></div>
      </div>
    </div>

    <div class="chart-card wide">
      <div class="chart-header">
        <div class="chart-title">Chamados por Sala / Local</div>
        <span class="chart-tag">COLUNAS</span>
      </div>
      <div class="chart-area" id="chart-salas">
        <div class="loading-wrap"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">Chamados Recentes</div>
      <span class="chart-tag">TABELA</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Data / Hora</th>
            <th>Sala</th>
            <th>Categoria</th>
            <th>Urgência</th>
            <th>Descrição</th>
            <th>Solicitante</th>
          </tr>
        </thead>
        <tbody id="tabela-recentes">
          <tr><td colspan="6" style="text-align:center">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<footer>Dashboard <strong>CAP · FMC</strong> · 2026</footer>

<script>
const SHEET_ID  = '1pshUNeBk-30YxnuYttnVDNioI5LXrHgGQfRY21pehng';
const SHEET_TAB = 'Form_Responses';

const COL_DATA        = 0;
const COL_SALA        = 1;
const COL_CATEGORIA   = 2;
const COL_URGENCIA    = 3;
const COL_DESCRICAO   = 4;
const COL_SOLICITANTE = 5;

const PALETA = ['#1E6B52','#3AAB85','#5DC9A5','#8BC4B0','#F4A261','#E05C5C'];

google.charts.load('current', { packages: ['corechart'], language: 'pt' });
google.charts.setOnLoadCallback(fetchAndDraw);

function fetchAndDraw() {
  const url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?sheet=' + encodeURIComponent(SHEET_TAB) + '&tq=select%20*&headers=1';
  const query = new google.visualization.Query(url);
  query.send(handleQueryResponse);
}

function handleQueryResponse(resp) {
  if (resp.isError()) {
    console.error(resp.getMessage());
    return;
  }
  const dt = resp.getDataTable();
  const rows = [];
  for (let i = 0; i < dt.getNumberOfRows(); i++) {
    rows.push({
      data: dt.getFormattedValue(i, COL_DATA),
      sala: (dt.getFormattedValue(i, COL_SALA) || '').trim(),
      categoria: (dt.getFormattedValue(i, COL_CATEGORIA) || '').trim(),
      urgencia: (dt.getFormattedValue(i, COL_URGENCIA) || '').trim(),
      descricao: (dt.getFormattedValue(i, COL_DESCRICAO) || '').trim(),
      solicitante: (dt.getFormattedValue(i, COL_SOLICITANTE) || '').trim()
    });
  }
  updateKPIs(rows);
  drawCategorias(rows);
  drawUrgencia(rows);
  drawSalas(rows);
  drawTabela(rows);
  updateTimestamp();
}

function updateKPIs(rows) {
  const total = rows.length;
  const alta = rows.filter(r => r.urgencia.toUpperCase().includes('ALTA')).length;
  const media = rows.filter(r => r.urgencia.toUpperCase().includes('M')).length;
  const catCount = {};
  rows.forEach(r => { catCount[r.categoria] = (catCount[r.categoria] || 0) + 1; });
  const sortedCats = Object.entries(catCount).sort((a,b) => b[1]-a[1]);
  const topCat = sortedCats[0] ? sortedCats[0][0].split('/')[0] : '—';

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-alta').textContent = alta;
  document.getElementById('kpi-alta-pct').textContent = Math.round(alta/total*100) + '% do total';
  document.getElementById('kpi-media').textContent = media;
  document.getElementById('kpi-media-pct').textContent = Math.round(media/total*100) + '% do total';
  document.getElementById('kpi-top-cat').textContent = topCat;
  document.getElementById('kpi-top-cat-n').textContent = sortedCats[0] ? sortedCats[0][1] + ' chamados' : '';
}

function drawCategorias(rows) {
  const count = {};
  rows.forEach(r => { 
    const label = r.categoria.split('/')[0].trim();
    count[label] = (count[label] || 0) + 1; 
  });
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Categoria');
  data.addColumn('number', 'Chamados');
  Object.entries(count).forEach(([k,v]) => data.addRow([k, v]));
  new google.visualization.BarChart(document.getElementById('chart-categorias')).draw(data, {
    backgroundColor: 'transparent', legend: 'none', colors: [PALETA[1]],
    chartArea: {width: '60%', height: '80%'}
  });
}

function drawUrgencia(rows) {
  const count = {};
  rows.forEach(r => { 
    let u = r.urgencia;
    if(u.toUpperCase().includes('ALTA')) u = 'Alta';
    else if(u.toUpperCase().includes('M')) u = 'Média';
    else u = 'Baixa';
    count[u] = (count[u] || 0) + 1; 
  });
  const data = google.visualization.arrayToDataTable([
    ['Urgência', 'Qtd'],
    ['Alta', count['Alta'] || 0],
    ['Média', count['Média'] || 0],
    ['Baixa', count['Baixa'] || 0]
  ]);
  new google.visualization.PieChart(document.getElementById('chart-urgencia')).draw(data, {
    backgroundColor: 'transparent', colors: ['#E05C5C','#F4A261','#3AAB85'],
    pieHole: 0.4, chartArea: {width: '90%', height: '80%'}
  });
}

function drawSalas(rows) {
  const count = {};
  rows.forEach(r => { count[r.sala] = (count[r.sala] || 0) + 1; });
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Sala');
  data.addColumn('number', 'Chamados');
  Object.entries(count).forEach(([k,v]) => data.addRow([k, v]));
  new google.visualization.ColumnChart(document.getElementById('chart-salas')).draw(data, {
    backgroundColor: 'transparent', legend: 'none', colors: [PALETA[2]]
  });
}

function drawTabela(rows) {
  const recentes = [...rows].reverse().slice(0, 10);
  document.getElementById('tabela-recentes').innerHTML = recentes.map(r => {
    const urgClass = r.urgencia.toUpperCase().includes('ALTA') ? 'badge-alta' : r.urgencia.toUpperCase().includes('M') ? 'badge-media' : 'badge-baixa';
    return `<tr>
      <td>${r.data}</td>
      <td><strong>${r.sala}</strong></td>
      <td>${r.categoria.split('/')[0]}</td>
      <td><span class="badge ${urgClass}">${r.urgencia}</span></td>
      <td>${r.descricao.substring(0,30)}...</td>
      <td>${r.solicitante}</td>
    </tr>`;
  }).join('');
}

function updateTimestamp() {
  const now = new Date();
  document.getElementById('last-update').textContent = 'atualizado ' + now.getHours() + ':' + now.getMinutes().toString().padStart(2,'0');
}

setInterval(fetchAndDraw, 30000);
</script>
</body>
</html>
