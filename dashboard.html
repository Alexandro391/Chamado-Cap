<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP ¬∑ Dashboard de Chamados</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<style>
  :root {
    --g1: #0D3D2A;
    --g2: #1E6B52;
    --g3: #3AAB85;
    --g4: #5DC9A5;
    --g5: #C8EFE2;
    --g6: #EBF9F4;
    --red: #E05C5C;
    --yellow: #F4A261;
    --bg: #F2FAF6;
    --card: #FFFFFF;
    --text: #0D1F17;
    --sub: #5A7A6A;
    --border: #D4EDE2;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  header {
    background: var(--g1);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.25);
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo-badge {
    width: 38px; height: 38px;
    background: var(--g3);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 13px; color: white;
    letter-spacing: 0.5px;
  }
  .header-title { font-size: 16px; font-weight: 600; color: white; }
  .header-sub { font-size: 12px; color: var(--g4); margin-top: 1px; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .pulse-dot {
    width: 8px; height: 8px;
    background: var(--g4); border-radius: 50%;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; transform: scale(1); }
    50%      { opacity: 0.4; transform: scale(1.3); }
  }
  .live-label { font-size: 12px; color: var(--g4); font-family: 'DM Mono', monospace; }
  #last-update { font-size: 11px; color: #5a8570; font-family: 'DM Mono', monospace; }

  main { max-width: 1300px; margin: 0 auto; padding: 28px 24px 48px; }

  .kpi-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .kpi-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px 22px;
    position: relative; overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(30,107,82,0.1); }
  .kpi-card::before {
    content: ''; position: absolute;
    top: 0; left: 0; right: 0; height: 3px;
    background: var(--accent, var(--g3));
  }
  .kpi-label { font-size: 11px; font-weight: 600; color: var(--sub); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .kpi-value { font-size: 36px; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .kpi-note { font-size: 12px; color: var(--sub); }
  .kpi-icon { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); font-size: 28px; opacity: 0.12; }

  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 22px 24px 18px;
    transition: box-shadow 0.2s;
  }
  .chart-card:hover { box-shadow: 0 6px 24px rgba(30,107,82,0.08); }
  .chart-card.wide { grid-column: 1 / -1; }
  .chart-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
  .chart-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .chart-sub { font-size: 12px; color: var(--sub); margin-top: 2px; }
  .chart-tag {
    font-size: 10px; font-weight: 600;
    background: var(--g6); color: var(--g2);
    border: 1px solid var(--g5); border-radius: 20px;
    padding: 3px 10px; white-space: nowrap;
  }
  .chart-area { width: 100%; }

  .loading-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 220px; gap: 14px; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--g5); border-top-color: var(--g3); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 13px; color: var(--sub); }

  .error-box { background: #FFF0F0; border: 1px solid #FFCCCC; border-radius: 10px; padding: 20px; color: #CC4444; font-size: 13px; text-align: center; }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead tr { background: var(--g1); color: white; }
  thead th { padding: 11px 14px; text-align: left; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover { background: var(--g6); }
  tbody td { padding: 10px 14px; color: var(--text); vertical-align: middle; }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .badge-alta  { background: #FFE5E5; color: #C43E3E; }
  .badge-media { background: #FFF4E5; color: #C47A1A; }
  .badge-baixa { background: #E8F7F1; color: #1A7A52; }

  footer { text-align: center; padding: 24px; font-size: 12px; color: var(--sub); border-top: 1px solid var(--border); margin-top: 8px; }
  footer strong { color: var(--g2); }

  @media (max-width: 768px) {
    .kpi-row { grid-template-columns: 1fr 1fr; }
    .charts-grid { grid-template-columns: 1fr; }
    .chart-card.wide { grid-column: 1; }
    header { padding: 0 16px; }
    main { padding: 16px 12px 40px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo-badge">CAP</div>
    <div>
      <div class="header-title">Dashboard de Chamados</div>
      <div class="header-sub">Central de Apoio Pedag√≥gico ¬∑ FMC</div>
    </div>
  </div>
  <div class="header-right">
    <div class="pulse-dot"></div>
    <span class="live-label">AO VIVO</span>
    <span id="last-update">‚Äî</span>
  </div>
</header>

<main>

  <div class="kpi-row">
    <div class="kpi-card" style="--accent:#3AAB85">
      <div class="kpi-label">Total de Chamados</div>
      <div class="kpi-value" id="kpi-total">‚Äî</div>
      <div class="kpi-note">desde o in√≠cio</div>
      <div class="kpi-icon">üìã</div>
    </div>
    <div class="kpi-card" style="--accent:#E05C5C">
      <div class="kpi-label">Alta Urg√™ncia</div>
      <div class="kpi-value" id="kpi-alta">‚Äî</div>
      <div class="kpi-note" id="kpi-alta-pct">‚Äî</div>
      <div class="kpi-icon">üî¥</div>
    </div>
    <div class="kpi-card" style="--accent:#F4A261">
      <div class="kpi-label">M√©dia Urg√™ncia</div>
      <div class="kpi-value" id="kpi-media">‚Äî</div>
      <div class="kpi-note" id="kpi-media-pct">‚Äî</div>
      <div class="kpi-icon">üü°</div>
    </div>
    <div class="kpi-card" style="--accent:#5DC9A5">
      <div class="kpi-label">Categoria Mais Frequente</div>
      <div class="kpi-value" style="font-size:18px;padding-top:4px" id="kpi-top-cat">‚Äî</div>
      <div class="kpi-note" id="kpi-top-cat-n">‚Äî</div>
      <div class="kpi-icon">üèÜ</div>
    </div>
  </div>

  <div class="charts-grid">

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">Chamados por Categoria</div>
          <div class="chart-sub">Distribui√ß√£o por tipo de problema</div>
        </div>
        <span class="chart-tag">BARRAS</span>
      </div>
      <div class="chart-area" id="chart-categorias">
        <div class="loading-wrap"><div class="spinner"></div><span class="loading-text">Carregando dados...</span></div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">N√≠vel de Urg√™ncia</div>
          <div class="chart-sub">Propor√ß√£o Alta ¬∑ M√©dia ¬∑ Baixa</div>
        </div>
        <span class="chart-tag">PIZZA</span>
      </div>
      <div class="chart-area" id="chart-urgencia">
        <div class="loading-wrap"><div class="spinner"></div><span class="loading-text">Carregando dados...</span></div>
      </div>
    </div>

    <div class="chart-card wide">
      <div class="chart-header">
        <div>
          <div class="chart-title">Chamados por Sala / Local</div>
          <div class="chart-sub">Volume de chamados por espa√ßo</div>
        </div>
        <span class="chart-tag">COLUNAS</span>
      </div>
      <div class="chart-area" id="chart-salas">
        <div class="loading-wrap"><div class="spinner"></div><span class="loading-text">Carregando dados...</span></div>
      </div>
    </div>

  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div>
        <div class="chart-title">Chamados Recentes</div>
        <div class="chart-sub">√öltimos 10 registros</div>
      </div>
      <span class="chart-tag">TABELA</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Data / Hora</th>
            <th>Sala</th>
            <th>Categoria</th>
            <th>Urg√™ncia</th>
            <th>Descri√ß√£o</th>
            <th>Solicitante</th>
          </tr>
        </thead>
        <tbody id="tabela-recentes">
          <tr><td colspan="6" style="text-align:center;padding:24px;color:#888">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<footer>
  Dashboard <strong>CAP ¬∑ FMC</strong> ¬∑ Sistema de Chamados R√°pido ¬∑ 2026 ¬∑
  Atualiza automaticamente a cada <strong>30 segundos</strong>
</footer>

<script>
const SHEET_ID  = '1pshUNeBk-30YxnuYttnVDNioI5LXrHgGQfRY21pehng';
const SHEET_TAB = 'Form_Responses';

const COL_DATA        = 0;
const COL_SALA        = 1;
const COL_CATEGORIA   = 2;
const COL_URGENCIA    = 3;
const COL_DESCRICAO   = 4;
const COL_SOLICITANTE = 5;

const PALETA = ['#1E6B52','#3AAB85','#5DC9A5','#8BC4B0','#F4A261','#E05C5C','#888888','#B0C4BA'];

google.charts.load('current', { packages: ['corechart'], language: 'pt' });
google.charts.setOnLoadCallback(fetchAndDraw);

function fetchAndDraw() {
  const url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?sheet=' + encodeURIComponent(SHEET_TAB) + '&tq=select%20*&headers=1';
  const query = new google.visualization.Query(url);
  
  // O SEGREDO EST√Å NESTA LINHA ABAIXO:
  query.send(handleQueryResponse); 
}

function handleResponse(resp) {
  if (resp.isError()) {
    showError('N√£o foi poss√≠vel carregar os dados. Verifique se a planilha est√° compartilhada como "Qualquer pessoa com o link pode ver".<br><br>Detalhe: ' + resp.getMessage());
    return;
  }

  const dt = resp.getDataTable();
  const rows = [];

  for (let i = 0; i < dt.getNumberOfRows(); i++) {
  rows.push({
    data:        dt.getFormattedValue(i, COL_DATA),
    sala:        (dt.getFormattedValue(i, COL_SALA) || '').trim(),
    categoria:   (dt.getFormattedValue(i, COL_CATEGORIA) || '').trim(),
    urgencia:    (dt.getFormattedValue(i, COL_URGENCIA) || '').trim(),
    descricao:   (dt.getFormattedValue(i, COL_DESCRICAO) || '').trim(),
    solicitante: (dt.getFormattedValue(i, COL_SOLICITANTE) || '').trim()
  });
}

  if (rows.length === 0) {
    showError('A planilha est√° vazia ou os dados n√£o foram encontrados.');
    return;
  }

  updateKPIs(rows);
  drawCategorias(rows);
  drawUrgencia(rows);
  drawSalas(rows);
  drawTabela(rows);
  updateTimestamp();
}

function updateKPIs(rows) {
  const total = rows.length;
  const alta  = rows.filter(r => r.urgencia === 'Alta').length;
  const media = rows.filter(r => r.urgencia === 'M√©dia').length;

  const catCount = {};
  rows.forEach(r => { catCount[r.categoria] = (catCount[r.categoria] || 0) + 1; });
  const topCat = Object.entries(catCount).sort((a,b) => b[1]-a[1])[0];
  const topCatShort = (topCat[0] || '').split('/')[0].trim();

  document.getElementById('kpi-total').textContent     = total;
  document.getElementById('kpi-alta').textContent      = alta;
  document.getElementById('kpi-alta-pct').textContent  = Math.round(alta/total*100) + '% dos chamados';
  document.getElementById('kpi-media').textContent     = media;
  document.getElementById('kpi-media-pct').textContent = Math.round(media/total*100) + '% dos chamados';
  document.getElementById('kpi-top-cat').textContent   = topCatShort;
  document.getElementById('kpi-top-cat-n').textContent = topCat[1] + ' chamados';
}

function drawCategorias(rows) {
  const count = {};
  rows.forEach(r => {
    const label = (r.categoria || 'Outro').split('/')[0].trim();
    count[label] = (count[label] || 0) + 1;
  });
  const sorted = Object.entries(count).sort((a,b) => b[1]-a[1]);

  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Categoria');
  data.addColumn('number', 'Chamados');
  data.addColumn({type:'string', role:'style'});
  data.addColumn({type:'string', role:'annotation'});
  sorted.forEach(([cat, val], i) => {
    data.addRow([cat, val, 'color: ' + PALETA[i % PALETA.length] + '; opacity: 0.9', String(val)]);
  });

  const options = {
    chartArea:  { left: 140, right: 60, top: 10, bottom: 10, width:'100%', height:'85%' },
    backgroundColor: 'transparent',
    bar:        { groupWidth: '62%' },
    legend:     { position: 'none' },
    annotations:{ alwaysOutside: true, textStyle: { fontSize: 12, bold: true, color: '#1A1A1A' } },
    hAxis:      { gridlines: { color: '#EEF8F4' }, textStyle: { color: '#888', fontSize: 11 }, minValue: 0 },
    vAxis:      { textStyle: { color: '#0D1F17', fontSize: 12 } },
    animation:  { startup: true, duration: 800, easing: 'out' },
  };

  const el = document.getElementById('chart-categorias');
  el.style.height = Math.max(220, sorted.length * 44) + 'px';
  new google.visualization.BarChart(el).draw(data, options);
}

function drawUrgencia(rows) {
  const count = {};
  rows.forEach(r => { count[r.urgencia] = (count[r.urgencia] || 0) + 1; });

  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Urg√™ncia');
  data.addColumn('number', 'Chamados');
  ['Alta','M√©dia','Baixa'].forEach(u => { if (count[u]) data.addRow([u, count[u]]); });

  const options = {
    chartArea:       { left: 20, right: 20, top: 10, bottom: 50, width:'100%', height:'80%' },
    backgroundColor: 'transparent',
    colors:          ['#E05C5C','#F4A261','#3AAB85'],
    legend:          { position: 'bottom', textStyle: { color: '#0D1F17', fontSize: 12 } },
    pieHole:         0.42,
    pieSliceBorderColor: 'white',
    pieSliceTextStyle:   { color: 'white', fontSize: 13, bold: true },
    animation:       { startup: true, duration: 900, easing: 'out' },
    tooltip:         { text: 'both' },
  };

  const el = document.getElementById('chart-urgencia');
  el.style.height = '280px';
  new google.visualization.PieChart(el).draw(data, options);
}

function drawSalas(rows) {
  const count = {};
  rows.forEach(r => {
    let sala = (r.sala || 'N√£o informado').trim();
    sala = sala.replace(/^sala\s+/i, 'Sala ').replace(/^(\d+)$/, 'Sala $1');
    count[sala] = (count[sala] || 0) + 1;
  });
  const sorted = Object.entries(count).sort((a,b) => b[1]-a[1]);

  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Sala');
  data.addColumn('number', 'Chamados');
  data.addColumn({type:'string', role:'style'});
  data.addColumn({type:'string', role:'annotation'});
  sorted.forEach(([sala, val]) => {
    const cor = val >= 4 ? '#1E6B52' : val >= 2 ? '#3AAB85' : '#5DC9A5';
    data.addRow([sala, val, 'color: ' + cor + '; opacity: 0.9', String(val)]);
  });

  const options = {
    chartArea:  { left: 50, right: 30, top: 10, bottom: 60, width:'100%', height:'75%' },
    backgroundColor: 'transparent',
    bar:        { groupWidth: '58%' },
    legend:     { position: 'none' },
    annotations:{ alwaysOutside: true, textStyle: { fontSize: 12, bold: true, color: '#1A1A1A' } },
    hAxis:      { textStyle: { color: '#0D1F17', fontSize: 12 }, slantedText: true, slantedTextAngle: 30 },
    vAxis:      { gridlines: { color: '#EEF8F4' }, textStyle: { color: '#888', fontSize: 11 }, minValue: 0, format: '0' },
    animation:  { startup: true, duration: 800, easing: 'out' },
  };

  const el = document.getElementById('chart-salas');
  el.style.height = '280px';
  new google.visualization.ColumnChart(el).draw(data, options);
}

function drawTabela(rows) {
  const recentes = [...rows].reverse().slice(0, 10);
  document.getElementById('tabela-recentes').innerHTML = recentes.map(r => {
    const urg = r.urgencia || '‚Äî';
    const badge = urg === 'Alta' ? 'badge-alta' : urg === 'M√©dia' ? 'badge-media' : 'badge-baixa';
    const cat  = (r.categoria || '‚Äî').split('/')[0].trim();
    const desc = r.descricao && r.descricao.length > 40 ? r.descricao.slice(0,40) + '‚Ä¶' : (r.descricao || '‚Äî');
    const sala = (r.sala || '‚Äî').replace(/^(\d+)$/, 'Sala $1');
    return '<tr><td style="font-family:\'DM Mono\',monospace;font-size:11px;white-space:nowrap">' + r.data + '</td><td><strong>' + sala + '</strong></td><td>' + cat + '</td><td><span class="badge ' + badge + '">' + urg + '</span></td><td style="color:#5A7A6A">' + desc + '</td><td>' + (r.solicitante || '‚Äî') + '</td></tr>';
  }).join('');
}

function updateTimestamp() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('last-update').textContent = 'atualizado ' + hh + ':' + mm + ':' + ss;
}

function showError(msg) {
  ['chart-categorias','chart-urgencia','chart-salas'].forEach(id => {
    document.getElementById(id).innerHTML = '<div class="error-box">‚ö†Ô∏è ' + msg + '</div>';
  });
}

setInterval(fetchAndDraw, 30000);
</script>
</body>
</html>
